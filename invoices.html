<!DOCTYPE html>
<html>
<head>
    <title>Invoices</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

    <script type="text/javascript">
        var fieldNames = { "invoiceNo" : "Invoice Number",
            "invoiceDate": "Invoice Date",
            "grossTotal": "Gross Total",
            "companyName": "Company Name"};

        function submitForm() {

            var form = "?";
            form += $('form').serialize();
            console.log(form);

            $.ajax($('#content form').attr('action') + form, {
                type: "GET",
                data: "",
                success: function(data)
                {
                    drawSearchResults(data, fieldNames);
                },
                error: function(a, b, c)
                {
                    console.log(a + ", " + b + ", " + c);
                }
            })
        }

        function drawSearchResults(data, fieldNames) {
            var json = JSON.parse(data);
            var tables = "<table class=\"paginated\">";

            // print table headers
            tables += "<thead><tr>";
            for(field in json[0]) {
                tables += "<th>";
                tables += fieldNames[field];
                tables += "</th>"
            }
            tables += "</tr></thead>";

            tables += "<tbody>"
            // print table contents
            for(result in json) {
                tables += "<tr>";
                var object = json[result];
                for(field in object) {
                    tables += "<td>";
                    tables += object[field];
                    tables += "</td>";
                }
                tables += "</tr>";
            }

            tables += "</tbody></table>";
            $("#results").html(tables);

            // paginate the table
            $('table.paginated').each(function() {
                var currentPage = 0;
                var numPerPage = 5;
                var $table = $(this);
                $table.bind('repaginate', function() {
                    $table.find('tbody tr').hide().slice(currentPage * numPerPage, (currentPage + 1) * numPerPage).show();
                });
                $table.trigger('repaginate');
                var numRows = $table.find('tbody tr').length;
                var numPages = Math.ceil(numRows / numPerPage);
                var $pager = $('<div class="pager"></div>');
                for (var page = 0; page < numPages; page++) {
                    $('<span class="page-number"></span>').text(page + 1).bind('click', {
                        newPage: page
                    }, function(event) {
                        currentPage = event.data['newPage'];
                        $table.trigger('repaginate');
                        $(this).addClass('active').siblings().removeClass('active');
                    }).appendTo($pager).addClass('clickable');
                }
                $pager.insertBefore($table).find('span.page-number:first').addClass('active');
            });
        }

        function getValueBoxes(operation) {
            var valueBoxes = "";
            if(operation == "range") {
                valueBoxes +=("<label>From: </label>");
                valueBoxes +=('<input name="value[]" type="text">');

                valueBoxes +=("   <label>To: </label>");
                valueBoxes +=('<input name="value[]" type="text">');
            }
            else if(operation != "min" && operation != "max") {
                valueBoxes +=('<label>Search for: </label>');
                valueBoxes +=('<input name="value[]" type="text">');
            }

            return valueBoxes;
        }

        function getOperation() {
            var op = $( "#op option:selected" ).val();
            $( "#queryBoxes" ).html( getValueBoxes(op) );
        }

        function displayResults(data) {
            $("#searchResults").html(data);
        }

    </script>

</head>
<body>

<div id="header">
    <h1>Invoices</h1>
    <h2>Search and details</h2>
</div>

<div id="menu">
    <ul>
        <li><a href="invoices.html">Invoices</a></li>
        <li><a href="">Customers</a></li>
        <li><a href="">Products</a></li>
    </ul>
</div>

<div id="content">
    <form action="./api/searchInvoicesByField.php" method="GET">
        <label for="op">Operation</label>
        <select id="op" name="op" onchange="getOperation()">
            <option value="" disabled selected style="display:none;">Please select one</option>
            <option value="range">Between</option>
            <option value="equal">Equals to</option>
            <option value="contains">Contains</option>
            <option value="min">Minimum</option>
            <option value="max">Maximum</option>
        </select><br><br>

        <div id="queryBoxes">
            <script>
            $(this).keypress(function(e) {
              if (e.keyCode == '13') {
               e.preventDefault();
            }
            });
            </script>
        </div><br>

        <label for="field">Field</label>
        <select id="field" name="field">
            <option value="invoiceNo">Invoice Number</option>
            <option value="invoiceDate">Invoice Date</option>
            <option value="companyName">Company Name</option>
            <option value="taxPayable">Tax payable</option>
            <option value="netTotal">Net Total</option>
            <option value="grossTotal">Gross total</option>
        </select><br>

        <input type="button" value="Submit" onclick="submitForm(); return false;">
    </form>

    <div id="results"></div>


</div>

</body>
</html>